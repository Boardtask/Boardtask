---
description: Migrations must never destroy data; only add or migrate, then optionally remove after data is preserved
alwaysApply: true
---

# Migrations: No Data Destruction

Migrations must **never** drop or remove data in a way that destroys user or business data. Any change to the database schema or contents must preserve information or explicitly document why removal is safe.

## Rules

- **Never destroy data.** Do not `DROP TABLE`, `DROP COLUMN`, or `DELETE` rows in a way that loses information the application or users rely on.
- **Removing schema in two phases:** To retire a table or column:
  1. **Migrate first:** Add the new schema, backfill/migrate all data from the old structure into the new one, and ensure the app uses the new structure.
  2. **Drop only after data is safe:** In a later migration you may drop the old table or column only when the data is fully preserved elsewhere and the app no longer reads the old structure.
- **Prefer additive migrations.** Prefer `ADD COLUMN`, new tables, and new indexes. When you must remove something, always migrate data before dropping.
- **No destructive DELETEs.** Do not `DELETE` from tables that hold user content or critical reference data unless you have an explicit, documented strategy (e.g. archival, retention, or obsoleting after migration). Cleaning up orphaned or obsolete reference rows (e.g. a node type with zero references after migration) is acceptable when documented in the migration.
- **Document removals.** Any migration that drops a table or column must state in comments where the data now lives or why the drop is safe (e.g. "Data migrated to `nodes` in 20260221100000_unify_groups_into_nodes.sql").

## Allowed

- Adding tables, columns, indexes.
- Migrating data from old tables/columns into new ones, then dropping the old structure in a **later** migration.
- Dropping empty or unused tables/columns **after** data has been migrated and the app no longer uses them.
- Idempotent, additive statements (`INSERT OR IGNORE`, `ADD COLUMN ... DEFAULT`, etc.).

## Not allowed

- Dropping a table or column that still holds the only copy of user or business data.
- Deleting rows that represent user content or essential reference data without a documented, intentional strategy.
- Single-step "remove feature" migrations that drop schema without a prior migration that preserves the data elsewhere.
